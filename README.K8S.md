# K8S

## Prerequisites

- Kubernetes
- Helm

## Install Kubernetes with Kind

1. You can use any Kubernetes cluster, or install [Kind](https://kind.sigs.k8s.io/docs/user/quick-start/#installation) in your Docker.

2. Create cluster.

```
kind create cluster --config=.k8s/kind.yaml --name=kind
```
    
3. Set kubectl content for the new created cluster.

```
kubectl cluster-info --context kind-kind
```

4. Install NGINX Ingress Controller for Kind:

```
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml
```

4.1. This command may install the Ingress Controller deployment on the wrong node, in one of the workers instead of 
the control-plane. To fix that download the manifest file on your machine, to edit it.

```
curl https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml > ingress-nginx-kind.yaml
```

4.2. Edit the deployment to add node selector:

```
# Download the file first, then find the Deployment section and add nodeSelector
# Look for: kind: Deployment, name: ingress-nginx-controller
# Under spec.template.spec, add:
      nodeSelector:
        ingress-ready: "true"
```

4.3. Delete the current Ingress Controller if you had installed it, and apply the new one.

```
kubectl delete -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml
kubectl apply -f .k8s/ingress-nginx.kind.yaml
```

5. Wait for it to be ready:

```
kubectl wait --namespace ingress-nginx \
  --for=condition=ready pod \
  --selector=app.kubernetes.io/component=controller \
  --timeout=90s
```

6. Use the same Ingress resource from before (but remove host: localhost or use a custom host in hosts)

hosts.sample
```
# This file was automatically generated by WSL. To stop automatic generation of this file, add the following entry to /etc/wsl.conf:
# [network]
# generateHosts = false
127.0.0.1	localhost
127.0.1.1	avell-mc.localdomain	avell-mc

# The following lines are desirable for IPv6 capable hosts
::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters

```

7. Access directly:

http://localhost/swagger-ui/index.html → backend
http://localhost/ → frontend

**No port-forward needed** - the Kind cluster maps container ports 80/443 to your host!

## Install Helm

1. Follow the [Helm installation guide](https://helm.sh/docs/intro/install/).

## Help Cheat Sheet

```
# Run tests to examine a chart and identify possible issues:
helm lint helm/postgres 

# Run a test installation to validate chart (p)
helm template <name> helm/postgres --values helm/postgres/values.yaml --debug 

# Run a test installation to validate chart (p)
helm template <name> helm/postgres --dry-run --debug 

# Install the chart
helm install <name> helm/postgres

# Install the chart in a specific namespace
helm install <name> helm/postgres --namespace <namespace> 

# Lists all of the releases for a specified namespace, uses current namespace context if namespace not specified
helm list

# Uninstalls a release from the current (default) namespace
help uninstall <name> 

# Uninstalls a release from the specified namespace
helm uninstall <release-name> --namespace <namespace> 
```